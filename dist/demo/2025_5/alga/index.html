<style>
  body {
    --main-color: #079267;
    color: #093f2a;
    background: #e7eceb;
    font-family: sans-serif;
    font-size: 20px;
    max-width: 700px;
    margin: 20px auto;
    line-height: 1.5;
  }
  li {
    margin: 10px 0;
  }
  hr {
    border: 0.5px solid var(--main-color);
    margin: 50px 0;
  }
  @media (max-width: 700px) {
    body {
      margin: 20px 10px;
    }
  }
  pre {
    font-family: "fira code";
    white-space: pre-wrap;
  }

  a:visited {
    color: var(--main-color);
  }
  a:hover {
    color: var(--main-color);
  }
  a:link {
    color: var(--main-color);
  }
  a:active {
    color: var(--main-color);
  }
</style>

<h1>Alga</h1>
<div>May 2 2025</div>

<p>
  This note is about Alga. The
  <a href="./alga_core.js">core</a> of alga is really about a certain funky sort
  of multidirectional computation, but it was designed to solve some layout
  language problems. In particular, it was designed to implement a relational
  layout combinator API similar to (and based on)
  <a href="https://bluefishjs.org/">Bluefish</a>'s with some additional
  properties I wanted.
</p>
<img src="./layers.svg" />
<p>
  Alga has three layers, the core, the layout API, and the renderer-specific
  API. So far I've only made a
  <a
    href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D"
    >canvas-2D</a
  >-specific API, but I think it would only take a couple hours to make an HTML
  or SVG or WebGL one.
</p>
<p>
  Alga core's multidirectional evaluation makes it effective for expressing
  direct-manipulable layouts. You can change any part of the layout, and any
  related parts of the diagram will be recomputed to respect relationships.
</p>

<p>Check out an example:</p>
<canvas
  id="c1"
  style="
    background: white;
    border-radius: 18px 18px 0 0;
    outline: 1px solid var(--main-color);
  "
></canvas>
<script type="module">
  const c = document.getElementById("c1");
  const ctx = c.getContext("2d");
  import {
    left,
    right,
    top,
    bottom,
    Point,
    Group2,
    set,
    spaceY,
    eq,
    centerBottom,
    centerTop,
    leftTop,
    rightTop,
    leftCenter,
    rightCenter,
  } from "./alga_api.js";
  import { d } from "./alga_canvas.js";

  // make things crispy
  const dpr = window.devicePixelRatio;
  const cw = 300;
  const ch = 300;
  c.width = cw * dpr;
  c.height = ch * dpr;
  c.style.width = cw + "px";
  c.style.height = ch + "px";
  ctx.scale(dpr, dpr);

  const {
    draw,
    Box,
    Outline,
    DraggableBox,
    DraggableOutline,
    deleteDrawable,
    Text,
    Line,
  } = d(ctx);

  const b1 = DraggableBox("yellowgreen");
  const b2 = DraggableBox("orangered");
  const b3 = DraggableBox("violet");
  const b4 = DraggableBox("cornflowerblue");
  b2.left = b1.right + 5;
  b4.left = b3.right + 5;
  const g1 = Outline(Group2(b1, b2));
  const g2 = Outline(Group2(b3, b4));
  g2.top = g1.bottom.plus(15);
  g1.top = 20;
  g1.left = 20;
  Line(g1.centerBottom, g2.centerTop);

  function anim() {
    requestAnimationFrame(anim);
    ctx.clearRect(0, 0, c.width, c.height);
    draw();
  }
  anim();
</script>
<br />
<pre
  style="
    font-size: 14px;
    background: white;
    padding: 12px;
    border-radius: 0 18px 18px 18px;
    outline: 1px solid var(--main-color);
  "
>
// imports and canvas set-up code are not shown in this code

const b1 = DraggableBox("yellowgreen");
const b2 = DraggableBox("orangered");
const b3 = DraggableBox("violet");
const b4 = DraggableBox("cornflowerblue");
<span style='color: orangered'>b2.left = b1.right + 5;</span>
<span style='color: orangered'>b4.left = b3.right + 5;</span>
const g1 = Outline(Group2(b1, b2));
const g2 = Outline(Group2(b3, b4));
<span style='color: var(--main-color)'>g2.top = g1.bottom.plus(15);</span>
<span style='color: orangered'>g1.top = 20;</span>
<span style='color: orangered'>g1.left = 20;</span>
Line(g1.centerBottom, g2.centerTop);
</pre>
<hr />
<canvas
  id="c"
  height="700"
  width="700"
  style="
    background: white;
    border-radius: 18px;
    outline: 1px solid var(--main-color);
  "
></canvas>
<script type="module">
  const c = document.getElementById("c");
  const ctx = c.getContext("2d");

  import {
    left,
    right,
    top,
    bottom,
    Point,
    Group2,
    set,
    set2,
    spaceX,
    spaceY,
    eq,
    eqOffset,
    eq2,
    stackX,
    stackY,
    stackXTop,
    centerBottom,
    centerTop,
    leftTop,
    rightTop,
    leftCenter,
    rightCenter,
  } from "./alga_api.js";
  import { d } from "./alga_canvas.js";

  // make things crispy
  const dpr = window.devicePixelRatio;
  const cw = 700;
  const ch = 700;
  c.width = cw * dpr;
  c.height = ch * dpr;
  c.style.width = cw + "px";
  c.style.height = ch + "px";
  ctx.scale(dpr, dpr);

  const {
    draw,
    Box,
    Outline,
    Arrow,
    DraggableBox,
    DraggableOutline,
    deleteDrawable,
    Text,
    Line,
  } = d(ctx);

  // high level goals:
  // - bluefish style relations with bounding boxes
  // - bidirectional for interactivity and expressivity of positioning

  const txtInit = DraggableBox();
  let txtL = Group2(txtInit);
  let txtO = Outline(txtL);
  let txtHead = txtInit;
  set2(leftTop(txtInit), [250, 200]);
  // next:
  // - better text rendering
  // - backspace (deleting object from group)
  // - left and right careting (along Arrows somehow?)
  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const newTxtInit = DraggableBox("red", 10, 10);
      const newTxtL = Group2(newTxtInit);
      stackY(txtL, newTxtL, 5);

      Arrow(centerBottom(txtHead), centerTop(newTxtInit));
      txtL = newTxtL;
      txtHead = newTxtInit;

      deleteDrawable(txtO);
      txtO = Outline(txtL);
      // what if this automatically outlined whatever txtO pointed at?
    } else {
      const newHead = Text(e.key);
      stackXTop(txtHead, newHead, 8);
      txtL.add(newHead);
      Arrow(rightCenter(txtHead), leftCenter(newHead));
      txtHead = newHead;
    }
  });
  // what if this text was in a group and the group auto-expanded?

  const exp = (numD, expD) => {
    eq2(rightTop(numD), leftCenter(expD));
    return Group2(numD, expD);
  };
  const FRAC_GAP = 8;
  const frac = (numD, denD) => {
    const g = stackY(numD, denD, FRAC_GAP);
    const l = Line();
    eq(left(l), left(g));
    eq(right(l), right(g));
    eqOffset(top(l), bottom(numD), -FRAC_GAP / 2);
    eqOffset(bottom(l), bottom(numD), -FRAC_GAP / 2);
    return g;
  };
  const sum = (topD, bottomD, rightD) => {
    const Σ = Text("Σ", 40);
    stackX(Σ, rightD);
    stackY(topD, Σ, 0);
    stackY(Σ, bottomD, 0);
    return Group2(Σ, topD, bottomD, rightD);
  };

  const g = stackX(
    Text("ζ(s) = "),
    sum(
      Text("∞", 22),
      Text("n=0"),
      frac(Text("1"), exp(Text("n"), Text("s", 12)))
    ),
    0
  );
  DraggableOutline(g);
  set2(leftTop(g), [30, 30]);

  const b1 = DraggableBox("yellowgreen");
  const b2 = DraggableBox("orangered");
  const b3 = DraggableBox("violet");
  const b4 = DraggableBox("cornflowerblue");
  set(left(b2), 20);
  set(left(b4), 20);
  const g1 = Outline(Group2(b1, b2));
  const g2 = Outline(Group2(b3, b4));
  const boundingExperiment = spaceY(20)(g1, g2);
  Line(centerBottom(g1), centerTop(g2));
  DraggableOutline(boundingExperiment);
  set(left(boundingExperiment), 30);
  set(top(boundingExperiment), 130);

  const dagNode = (...sts) => {
    const node = DraggableBox("orange");
    node.supremum = node;
    node.next = sts.map((st) => st.supremum);

    for (const subt of sts) Line(centerBottom(node), centerTop(subt.supremum));

    const subts = sts.filter((subt) => !subt.parent);
    if (subts.length === 0) return node;
    for (const subt of subts) subt.parent = node;

    const subtsBox = spaceX(20)(...subts);
    eq(left(subtsBox), left(node));

    const res = spaceY(30)(node, Group2(...subts));
    res.supremum = node;

    return res;
  };

  // actually a DAG
  const minNode = dagNode();
  const subDag1 = dagNode(dagNode(dagNode(minNode), dagNode(minNode)));
  const subDag2 = dagNode(dagNode(dagNode(minNode), dagNode(minNode)));
  const myDag = dagNode(
    dagNode(subDag1),
    dagNode(subDag1),
    dagNode(subDag1, subDag2)
  );

  DraggableOutline(myDag);
  set(left(myDag), 30);
  set(top(myDag), 230);

  function anim() {
    requestAnimationFrame(anim);
    ctx.clearRect(0, 0, c.width, c.height);
    draw();
  }
  anim();
</script>
